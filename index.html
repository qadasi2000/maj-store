/**
 * Ù†Ø¸Ø§Ù… Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø§Ø¬Ø¯ Ultra V17.2 Pro 
 * Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª:
 * 1. Ø§Ø¹ØªÙ…Ø§Ø¯ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ù…Ù† Ø§Ù„Ø®Ù„ÙŠØ© F2.
 * 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ø¹ ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± (Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹).
 */

var ss = SpreadsheetApp.getActiveSpreadsheet();

function doGet(e) {
  var settingsSheet = ss.getSheetByName("Settings");
  var settingsData = settingsSheet.getRange("A2:F2").getValues()[0];
  
  var discountPercent = parseFloat(settingsData[0]) || 0; 
  var signupBonus = parseFloat(settingsData[1]) || 0;     
  var newsText = settingsData[2] || "";                   
  var adminPass = settingsData[3] ? settingsData[3].toString() : "123456"; 
  var adminEmail = settingsData[4] || "";                 
  var adminIDFromSheet = settingsData[5] ? settingsData[5].toString().trim() : "777216718"; 

  var action = e.parameter.action;
  var id = e.parameter.id;
  var pass = e.parameter.password;
  var deviceId = e.parameter.deviceId;
  var adminPassParam = e.parameter.adminPass;

  var walletSheet = ss.getSheetByName("Ø§Ù„Ù…Ø­Ø§ÙØ¸");
  var topupSheet = ss.getSheetByName("Topups");
  var cardSheet = ss.getSheetByName("Cards");

  // --- [1] Ù‚Ø³Ù… Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø¢Ù„ÙŠ Ø§Ù„Ù…Ø·ÙˆØ± ---
  var receivedAmount = e.parameter.amount || e.parameter.data; 
  var receivedSender = e.parameter.sender; 

  if (receivedAmount && receivedSender) {
    var cleanAmount = parseFloat(receivedAmount);
    var ordersData = topupSheet.getDataRange().getValues();
    var foundRow = -1; var userId = "";
    for (var i = 1; i < ordersData.length; i++) {
      var orderAmt = parseFloat(ordersData[i][2]);
      var fullRefName = ordersData[i][3].toString().trim();
      var status = ordersData[i][4];
      var nameParts = fullRefName.split(/\s+/).filter(function(p) { return p.length > 0; });
      var firstTwoNames = nameParts.slice(0, 2).join(' '); 
      if ((status === "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" || status === "Pending") && orderAmt === cleanAmount && receivedSender.includes(firstTwoNames)) { 
        foundRow = i + 1;
        userId = ordersData[i][1].toString();
        break;
      }
    }
    if (foundRow !== -1) {
      topupSheet.getRange(foundRow, 5).setValue("Ù…ÙƒØªÙ…Ù„ âœ… (Ø¢Ù„ÙŠ)");
      var wData = walletSheet.getDataRange().getValues();
      for (var j = 1; j < wData.length; j++) {
        if (wData[j][0].toString() === userId) {
          var currentBal = parseFloat(wData[j][2]) || 0;
          walletSheet.getRange(j + 1, 3).setValue(currentBal + cleanAmount);
          return ContentService.createTextOutput("1");
        }
      }
    }
    return ContentService.createTextOutput("0");
  }

  // --- [2] Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆØ± ÙˆÙÙƒ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· ---
  if (action === "getWallet") {
    if (id === adminIDFromSheet && pass === adminPass) return res({success: true, isAdmin: true, balance: "Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…"});
    var data = walletSheet.getDataRange().getValues();
    for (var i = 1; i < data.length; i++) {
      if (data[i][0].toString() === id && data[i][1].toString() === pass) {
        if (data[i][3] && data[i][3] !== "" && data[i][3] !== deviceId) return res({success: false, isLocked: true, msg: "Ù…Ø±ØªØ¨Ø· Ø¨Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±"});
        if (!data[i][3]) walletSheet.getRange(i + 1, 4).setValue(deviceId);
        var pName = data[i][4] || ""; 
        return res({success: true, balance: data[i][2], paymentName: pName});
      }
    }
    return res({success: false, msg: "Ø®Ø·Ø£ ÙÙŠ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯"});
  }

  if (action === "register") {
    var data = walletSheet.getDataRange().getValues();
    for (var i = 1; i < data.length; i++) { if (data[i][0].toString() === id) return res({success: false, msg: "Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹"}); }
    walletSheet.appendRow([id, pass, signupBonus, deviceId, ""]);
    return res({success: true, balance: signupBonus, msg: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ âœ…"});
  }

  if (action === "resetDevice") {
    var data = walletSheet.getDataRange().getValues();
    for (var i = 1; i < data.length; i++) {
      if (data[i][0].toString() === id && data[i][1].toString() === pass) {
        walletSheet.getRange(i + 1, 4).clearContent(); 
        return res({success: true, msg: "ØªÙ… ÙÙƒ Ø§Ø±ØªØ¨Ø§Ø· Ø§Ù„Ø¬Ù‡Ø§Ø².. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†"});
      }
    }
    return res({success: false, msg: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©"});
  }

  // --- [3] Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø·Ù„Ø¨ Ø´Ø­Ù†ØŒ Ø´Ø±Ø§Ø¡ØŒ ØªØ­ÙˆÙŠÙ„) ---
  if (action === "requestTopup") {
    var amt = e.parameter.amount, ref = e.parameter.ref;
    var wData = walletSheet.getDataRange().getValues();
    var topupData = topupSheet.getDataRange().getValues();
    for (var i = 1; i < topupData.length; i++) {
      if (topupData[i][1].toString() === id && (topupData[i][4] === "Pending" || topupData[i][4] === "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±")) return res({success: false, msg: "Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø³Ø§Ø¨Ù‚ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©"});
    }
    for (var i = 1; i < wData.length; i++) {
      if (wData[i][0].toString() === id) {
        if (!wData[i][4] || wData[i][4] === "") { walletSheet.getRange(i + 1, 5).setValue(ref); }
        break;
      }
    }
    topupSheet.appendRow([new Date(), id, amt, ref, "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"]);
    if (adminEmail && adminEmail.includes("@")) { try { MailApp.sendEmail(adminEmail, "ğŸš¨ Ø·Ù„Ø¨ Ø´Ø­Ù† Ø±ØµÙŠØ¯ Ø¬Ø¯ÙŠØ¯", "Ù…Ø³ØªØ®Ø¯Ù…: " + id + "\nÙ…Ø¨Ù„Øº: " + amt); } catch(e) {} }
    return res({success: true, msg: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø§Ø³Ù…Ùƒ"});
  }

  if (action === "buyCard") {
    var cardType = e.parameter.cardType, qty = parseInt(e.parameter.qty || 1);
    var price = parseInt(cardType.replace(/[^0-9]/g, '')) || 0;
    var finalP = Math.floor(price * (1 - discountPercent)) * qty;
    var wData = walletSheet.getDataRange().getValues();
    var uRow = -1, bal = 0;
    for (var i = 1; i < wData.length; i++) { if (wData[i][0].toString() === id) { uRow = i + 1; bal = wData[i][2]; break; } }
    if (bal < finalP) return res({success: false, msg: "Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ"});
    var cData = cardSheet.getDataRange().getValues();
    var col = cData[0].indexOf(cardType);
    var codes = [], rows = [];
    for (var j = 2; j < cData.length && codes.length < qty; j++) { if (cData[j][col]) { codes.push(cData[j][col]); rows.push(j + 1); } }
    if (codes.length < qty) return res({success: false, msg: "Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ©"});
    walletSheet.getRange(uRow, 3).setValue(bal - finalP);
    rows.forEach(r => cardSheet.getRange(r, col + 1).clearContent());
    topupSheet.appendRow([new Date(), id, -finalP, "ÙƒÙˆØ¯ " + cardType + ": " + codes.join(" | "), "Ù…ÙƒØªÙ…Ù„ âœ…"]);
    return res({success: true, codes: codes, newBalance: bal - finalP});
  }

  if (action === "transfer") {
    var targetId = e.parameter.targetId, amount = parseFloat(e.parameter.amount);
    var data = walletSheet.getDataRange().getValues();
    var sRow=-1, rRow=-1, sBal=0, rBal=0;
    for (var i=1; i<data.length; i++) {
      if (data[i][0].toString() === id) { sRow=i+1; sBal=data[i][2]; }
      if (data[i][0].toString() === targetId) { rRow=i+1; rBal=data[i][2]; }
    }
    if (sRow===-1 || rRow===-1) return res({success:false, msg:"Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"});
    if (sBal < amount) return res({success:false, msg:"Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ"});
    walletSheet.getRange(sRow, 3).setValue(sBal - amount);
    walletSheet.getRange(rRow, 3).setValue(rBal + amount);
    topupSheet.appendRow([new Date(), id, -amount, "ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ " + targetId, "Ù…ÙƒØªÙ…Ù„ âœ…"]);
    topupSheet.appendRow([new Date(), targetId, amount, "Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† " + id, "Ù…ÙƒØªÙ…Ù„ âœ…"]);
    return res({success:true, newBalance: sBal - amount});
  }

  // --- [4] Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© ---
  if (action === "addStock") {
    if (adminPassParam !== adminPass) return res({success: false, msg: "Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ± Ø®Ø·Ø£"});
    var cardType = e.parameter.cardType;
    var newCodes = e.parameter.codes.split('\n').map(c => c.trim()).filter(c => c !== "");
    var data = cardSheet.getDataRange().getValues();
    var headers = data[0];
    var colIndex = headers.indexOf(cardType);
    if (colIndex === -1) return res({success: false, msg: "Ù†ÙˆØ¹ Ø§Ù„ÙƒØ±Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"});
    
    var existingCodes = [];
    for (var i = 2; i < data.length; i++) { if (data[i][colIndex]) existingCodes.push(data[i][colIndex].toString().trim()); }
    
    var uniqueNewCodes = newCodes.filter(code => !existingCodes.includes(code));
    var duplicateCount = newCodes.length - uniqueNewCodes.length;
    if (uniqueNewCodes.length === 0) return res({success: false, msg: "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù…ÙƒØ±Ø±Ø© ÙˆÙ…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹! âŒ"});

    uniqueNewCodes.forEach(code => {
      var rowToInsert = 3; 
      while (cardSheet.getRange(rowToInsert, colIndex + 1).getValue() !== "") { rowToInsert++; }
      cardSheet.getRange(rowToInsert, colIndex + 1).setValue(code);
    });
    return res({success: true, msg: "ØªÙ… Ø¥Ø¶Ø§ÙØ© " + uniqueNewCodes.length + " ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…" + (duplicateCount > 0 ? " (Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ " + duplicateCount + " Ù…ÙƒØ±Ø±)" : "")});
  }

  if (action === "updateSettings") {
    if (adminPassParam !== adminPass) return res({success: false, msg: "Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ± Ø®Ø·Ø£"});
    try {
      var newData = JSON.parse(e.parameter.data);
      settingsSheet.getRange("A2:F2").setValues([[newData.discount, newData.bonus, newData.ads, newData.adminPass, newData.email, newData.adminID]]);
      return res({success: true, msg: "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…"});
    } catch(err) { return res({success: false, msg: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"}); }
  }

  if (action === "getSettings") {
    return res({success: true, discount: discountPercent, bonus: signupBonus, ads: newsText, adminPass: adminPass, email: adminEmail, adminID: adminIDFromSheet});
  }

  if (action === "getAdminOrders") {
    if (adminPassParam !== adminPass) return res({success: false});
    var data = topupSheet.getDataRange().getValues(), pending = [];
    for (var i = 1; i < data.length; i++) { if (data[i][4] === "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" || data[i][4] === "Pending") pending.push({ row: i + 1, user: data[i][1], amount: data[i][2], ref: data[i][3] }); }
    return res({success: true, orders: pending});
  }

  if (action === "adminApprove") {
    if (adminPassParam !== adminPass) return res({success: false});
    var row = parseInt(e.parameter.row);
    var userIdApprove = topupSheet.getRange(row, 2).getValue().toString();
    var amtApprove = parseFloat(topupSheet.getRange(row, 3).getValue());
    var wData = walletSheet.getDataRange().getValues();
    for (var i = 1; i < wData.length; i++) {
      if (wData[i][0].toString() === userIdApprove) {
        walletSheet.getRange(i + 1, 3).setValue((parseFloat(wData[i][2]) || 0) + amtApprove);
        topupSheet.getRange(row, 5).setValue("Ù…ÙƒØªÙ…Ù„ âœ…");
        return res({success: true, msg: "ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯"});
      }
    }
  }

  if (action === "adminReject") {
    if (adminPassParam !== adminPass) return res({success: false});
    topupSheet.deleteRow(parseInt(e.parameter.row));
    return res({success: true, msg: "ØªÙ… Ø§Ù„Ø±ÙØ¶"});
  }

  // --- [5] Ø®Ø¯Ù…Ø§Øª Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
  if (action === "getStock") {
    var data = cardSheet.getDataRange().getValues(), stock = {};
    if (data.length > 1) {
      var headers = data[0], sizes = data[1];
      for (var j=0; j<headers.length; j++) {
        if (!headers[j]) continue;
        var count = 0;
        for (var i=2; i<data.length; i++) if (data[i][j]) count++;
        stock[headers[j]] = { count: count, size: sizes[j] || "" };
      }
    }
    return res({success: true, stock: stock, discount: discountPercent});
  }

  if (action === "getOrders") {
    var data = topupSheet.getDataRange().getValues(), userOrders = [];
    for (var i = 1; i < data.length; i++) { if (data[i][1].toString() === id) userOrders.push({ date: Utilities.formatDate(data[i][0], "GMT+3", "yyyy-MM-dd HH:mm"), amount: data[i][2], ref: data[i][3], status: data[i][4] }); }
    return res({success: true, orders: userOrders});
  }
}

function res(obj) { return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON); }
