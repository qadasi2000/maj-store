<script>
    const API = 'رابط_السكربت_الخاص_بك_هنا';
    const ADMIN_ID = "777216718";
    let myUser = "", myPass = "", isAdmin = false, paymentName = ""; 
    let hasPendingOrder = false;

    // دالة الدخول المحدثة لجلب الاسم المعتمد
    async function handleAuth(btn) {
        const u = toEnNum(document.getElementById('auth-user').value.trim());
        const p = document.getElementById('auth-pass').value.trim();
        if(!u || !p) return showT("يرجى إدخال البيانات", true);
        btn.disabled = true; loading(true);
        try {
            const res = await fetch(`${API}?action=getWallet&id=${u}&password=${p}&deviceId=${getID()}`).then(r => r.json());
            if(res.success) {
                myUser = u; myPass = p;
                isAdmin = res.isAdmin || (u === ADMIN_ID);
                paymentName = res.paymentName || ""; // جلب الاسم من العمود E
                localStorage.setItem('m_u', u); localStorage.setItem('m_p', p);
                loginOk(res.balance);
            } else {
                if(res.isLocked) document.getElementById('locked-box').classList.remove('hidden');
                showT(res.msg, true);
            }
        } catch(e) { showT("خطأ في الاتصال", true); }
        loading(false); btn.disabled = false;
    }

    // تحديث واجهة الشحن تلقائياً
    function updateTopupUI() {
        const refInput = document.getElementById('top-ref');
        const topupCard = refInput.parentElement;
        
        // إزالة أي رسالة سابقة إن وجدت
        const oldMsg = document.getElementById('approved-name-msg');
        if(oldMsg) oldMsg.remove();

        if (paymentName && paymentName.trim() !== "") {
            // إخفاء الخانة
            refInput.style.display = 'none';
            // إضافة الرسالة
            const msg = document.createElement('div');
            msg.id = 'approved-name-msg';
            msg.style.cssText = "background:rgba(0,255,136,0.1); border:1px solid var(--success); color:var(--success); padding:10px; border-radius:15px; font-size:0.8rem; margin-bottom:12px; text-align:center;";
            msg.innerHTML = `باسمك المعتمد المسجل مسبقاً:<br><strong>${paymentName}</strong>`;
            topupCard.insertBefore(msg, refInput);
        } else {
            // إظهار الخانة إذا لم يوجد اسم
            refInput.style.display = 'block';
        }
    }

    // تعديل دالة طلب الشحن لتستخدم الاسم التلقائي
    async function topupRequest(btn, isAuto = false) {
        if(hasPendingOrder) return showT("لديك طلب معلق بالفعل", true);
        const amt = toEnNum(document.getElementById('top-amt').value);
        
        // إذا كان هناك اسم معتمد نستخدمه، وإلا نأخذ المدخل من الخانة
        let ref = (paymentName && paymentName !== "") ? paymentName : document.getElementById('top-ref').value;

        if(isAuto) ref = "شحن_آلي";
        if(!amt || (!isAuto && !ref)) return showT("أكمل البيانات", true);

        btn.disabled = true; loading(true);
        try { 
            const res = await fetch(`${API}?action=requestTopup&id=${myUser}&amount=${amt}&ref=${encodeURIComponent(ref)}`).then(r => r.json()); 
            showT(res.msg); 
            if(res.success) {
                hasPendingOrder = true;
                updateTopupButtons();
                document.getElementById('top-amt').value = "";
                loadLogs(); 
            }
        } catch(e) { showT("خطأ في الاتصال", true); }
        loading(false); btn.disabled = false;
    }

    // عند الانتقال لصفحة الشحن، نقوم بتحديث الواجهة
    function switchSec(id, el) {
        document.querySelectorAll('.sec').forEach(s => s.classList.add('hidden'));
        document.getElementById('sec-'+id).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        
        if(id === 'topup') {
            updateTopupUI();
            loadLogs();
        }
    }

    // [بقية الدوال copyTxt, loadStore, transferMoney... تظل كما هي في كودك السليم]
</script>
